
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Knight Photo App</title>
  <style>
    body { background: #26264b; color: #fff; font-family: Arial,sans-serif; text-align: center; }
    .container { max-width: 480px; margin: 5vh auto; padding: 2em; background: #333357; border-radius: 16px; }
    input[type=file], button { margin: 1em 0; }
    #resultImage { max-width:100%; border: 2px solid #333; border-radius: 12px; margin-top: 1em; }
    #loadingSpinner { border: 5px solid #ccc; border-top: 5px solid #ffb700; border-radius: 50%; width: 48px; height: 48px; margin: 2em auto; animation: spin 1s linear infinite; display:none;}
    @keyframes spin { 0% { transform:rotate(0deg); } 100%{ transform:rotate(360deg); } }
    #webcamModal { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:20; align-items:center; justify-content:center;}
    #webcamInner { background:#222247; padding:2em; border-radius:14px; display:inline-block; position:relative;}
    #webcamVideo { width: 320px; height: 240px; background:#000; border-radius:8px; }
    #webcamCaptureBtn { background:#ffb700; color:#26264b; border:none; border-radius:6px; padding:0.7em 1.3em; font-size:1em; cursor:pointer; margin:0.8em 0;}
    #webcamCloseBtn { position:absolute; top:0.7em; right:1em; background:#222; color:#fff; border:none; border-radius:50%; width:2em; height:2em; cursor:pointer; font-size:1.2em;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Turn Yourself Into a Medieval Knight</h1>
    <input type="file" accept="image/*" id="imageInput"><br>
    <button id="uploadBtn">Transform!</button>
    <button id="webcamBtn">Use Webcam</button>
    <div id="loadingSpinner"></div>
    <img id="resultImage" style="display:none;" />
    <div id="message" style="color:#ffb700;margin-top:1em;"></div>
  </div>
  <div id="webcamModal">
    <div id="webcamInner">
      <button id="webcamCloseBtn">&times;</button>
      <video id="webcamVideo" autoplay playsinline></video><br>
      <button id="webcamCaptureBtn">Capture & Use Photo</button>
      <div style="color:#fff;font-size:0.93em; margin-top:0.6em;">Allow camera access.<br>Frame your face, then click "Capture & Use Photo".</div>
    </div>
  </div>
  <script>
    const img = document.getElementById('resultImage');
    const spinner = document.getElementById('loadingSpinner');
    const message = document.getElementById('message');
    const imageInput = document.getElementById('imageInput');
    let currentBlob = null;

    document.getElementById('uploadBtn').onclick = async function() {
      img.style.display = "none"; message.textContent = "";
      if (!currentBlob && !imageInput.files[0]) { message.textContent = "Please select an image or use webcam."; return; }
      spinner.style.display = "block";
      try {
        const form = new FormData();
        form.append('image', currentBlob || imageInput.files[0]);
        const res = await fetch('/.netlify/functions/userapi-proxy', {
          method: 'POST',
          body: form
        });
        const data = await res.json();
        spinner.style.display = "none";
        if (data.image) {
          img.src = data.image; img.style.display = "block"; currentBlob = null; imageInput.value = "";
        } else { message.textContent = data.error || "Something went wrong."; }
      } catch (err) { spinner.style.display = "none"; message.textContent = "Error: " + err.message; }
    };

    // Webcam logic
    const webcamBtn = document.getElementById('webcamBtn');
    const webcamModal = document.getElementById('webcamModal');
    const webcamVideo = document.getElementById('webcamVideo');
    const webcamCaptureBtn = document.getElementById('webcamCaptureBtn');
    const webcamCloseBtn = document.getElementById('webcamCloseBtn');
    let webcamStream = null;

    webcamBtn.onclick = async function() {
      webcamModal.style.display = "flex";
      try {
        webcamStream = await navigator.mediaDevices.getUserMedia({ video: true });
        webcamVideo.srcObject = webcamStream;
      } catch(e) { message.textContent = "Camera access denied."; webcamModal.style.display = "none"; }
    };
    webcamCaptureBtn.onclick = function() {
      const canvas = document.createElement('canvas');
      canvas.width = webcamVideo.videoWidth;
      canvas.height = webcamVideo.videoHeight;
      canvas.getContext('2d').drawImage(webcamVideo, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => { currentBlob = blob; webcamModal.style.display = "none"; stopWebcam(); });
    };
    webcamCloseBtn.onclick = function() { webcamModal.style.display = "none"; stopWebcam(); };
    function stopWebcam() {
      if (webcamStream) { webcamStream.getTracks().forEach(track=>track.stop()); webcamStream=null; }
    }
  </script>
</body>
</html>
